name: Build percolate-rocks (PyPI)

on:
  workflow_call:

env:
  PROJECT_DIR: percolate-rocks

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.check.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Extract and validate version
        id: check
        run: |
          echo "ðŸ” Validating percolate-rocks version..."

          # Get versions from both files
          CARGO_VERSION=$(grep '^version = ' ${{ env.PROJECT_DIR }}/Cargo.toml | cut -d'"' -f2)
          PYPROJECT_VERSION=$(grep '^version = ' ${{ env.PROJECT_DIR }}/pyproject.toml | cut -d'"' -f2)

          echo "ðŸ“„ Cargo.toml version:    ${CARGO_VERSION}"
          echo "ðŸ“„ pyproject.toml version: ${PYPROJECT_VERSION}"

          # Verify both files have same version
          if [ "$CARGO_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "âŒ Version mismatch between Cargo.toml and pyproject.toml!"
            echo "   Cargo.toml:    ${CARGO_VERSION}"
            echo "   pyproject.toml: ${PYPROJECT_VERSION}"
            exit 1
          fi

          VERSION="$CARGO_VERSION"
          echo "âœ… Version validation passed: v${VERSION}"
          echo "should_build=true" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

  build-wheels:
    needs: check-version
    if: needs.check-version.outputs.should_build == 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            platform: linux-amd64
          # - os: ubuntu-latest
          #   target: aarch64-unknown-linux-gnu
          #   platform: linux-arm64
          - os: macos-latest
            target: aarch64-apple-darwin
            platform: darwin-arm64
          # - os: macos-latest
          #   target: x86_64-apple-darwin
          #   platform: darwin-amd64

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            ${{ env.PROJECT_DIR }}/target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.target }}-cargo-

      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          target: ${{ matrix.target }}
          override: true

      - name: Install protobuf compiler
        run: |
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y protobuf-compiler
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            brew install protobuf
          fi

      - name: Install maturin
        run: pip install maturin

      - name: Build wheel
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          # Set minimum macOS version to 10.13 for Xcode 16.4 compatibility
          # Required for aligned deallocation in modern C++ standard library
          MACOSX_DEPLOYMENT_TARGET: "10.13"
        run: |
          echo "ðŸ”¨ Building wheel for ${{ matrix.platform }}"
          maturin build --release --target ${{ matrix.target }}
          ls -lh target/wheels/

      - name: Test wheel (native only)
        if: matrix.platform == 'linux-amd64' || matrix.platform == 'darwin-arm64'
        working-directory: ${{ env.PROJECT_DIR }}
        run: |
          # Install only the first wheel to avoid conflicts if multiple manylinux versions exist
          WHEEL=$(find target/wheels/ -name "*.whl" | sort | head -1)
          echo "ðŸ§ª Testing wheel: ${WHEEL}"
          pip install "${WHEEL}"
          python3 -c "import rem_db; print('âœ“ Import successful'); print(f'Version: {rem_db.__version__}')"

      - name: Upload wheel
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.platform }}
          path: ${{ env.PROJECT_DIR }}/target/wheels/*.whl
          retention-days: 30

  test-publish-summarize:
    name: Test, publish & summarize
    needs: [check-version, build-wheels]
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # For trusted publishing
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          path: wheels/

      - name: List wheels
        run: |
          echo "ðŸ“¦ Built wheels:"
          find wheels/ -name "*.whl" -exec ls -lh {} \;

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Test wheel
        run: |
          # Find and test only the first wheel (avoids conflicts if multiple manylinux versions exist)
          WHEEL=$(find wheels/wheel-linux-amd64/ -name "*.whl" | sort | head -1)
          echo "ðŸ§ª Testing wheel: ${WHEEL}"
          if [ -z "${WHEEL}" ]; then
            echo "âŒ No Linux wheel found"
            exit 1
          fi
          pip install "${WHEEL}"
          python3 -c "import rem_db; print('âœ“ Package import works')"
          python3 -c "from rem_db import Database; print('âœ“ Database class accessible')"

      - name: Install protobuf compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install maturin
        run: pip install maturin

      - name: Publish to PyPI
        working-directory: ${{ env.PROJECT_DIR }}
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "ðŸ“¤ Publishing percolate-rocks v${VERSION} to PyPI"

          # Copy wheels to target directory
          mkdir -p target/wheels
          find ../wheels/ -name "*.whl" -exec cp {} target/wheels/ \;

          # Publish with skip-existing in case of retries
          maturin publish --skip-existing

          echo "âœ… Published to PyPI"
          echo "ðŸ”— https://pypi.org/project/percolate-rocks/${VERSION}/"

      - name: Create build summary
        run: |
          VERSION="${{ needs.check-version.outputs.version }}"
          echo "### ðŸ percolate-rocks v${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Published to PyPI: https://pypi.org/project/percolate-rocks/${VERSION}/" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Platforms:** Linux (x86_64), macOS (Apple Silicon)" >> $GITHUB_STEP_SUMMARY
