name: Build All (Orchestrator)

on:
  push:
    branches:
      - main
    paths:
      - 'percolate-rocks/**'
      - 'percolate/**'
      - 'percolate-reading/**'
      - '.github/workflows/build-*.yml'

jobs:
  # Step 1: Build Python package (rocks)
  build-rocks:
    name: Build percolate-rocks
    uses: ./.github/workflows/build-rocks.yml
    secrets: inherit

  # Step 2: Build Docker images (depends on rocks)
  build-services:
    name: Build Docker images
    needs: build-rocks
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build percolate
        run: echo "TODO - docker build percolate"

      - name: Build percolate-reading
        run: echo "TODO - docker build percolate-reading"

  # Step 3: Summary
  summary:
    name: Build summary
    needs: [build-rocks, build-services]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Report
        run: |
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- percolate-rocks: ${{ needs.build-rocks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- services: ${{ needs.build-services.result }}" >> $GITHUB_STEP_SUMMARY
